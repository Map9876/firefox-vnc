name: Firefox with VNC and Cloudflared

on: [push]

jobs:
  firefox-vnc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11vnc firefox

    - name: Start Xvfb (virtual display)
      run: |
        Xvfb :99 -screen 0 1024x768x24 &
        export DISPLAY=:99

    - name: Start Firefox
      run: |
        firefox &
        sleep 5  # Wait for Firefox to start

    - name: Start VNC server
      run: |
        x11vnc -display :99 -forever -shared -passwd password &
        sleep 5  # Wait for VNC server to start

    - name: Install Cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared

    - name: Expose VNC service with Cloudflared
      run: |
        ./cloudflared tunnel --url tcp://localhost:5900 > cloudflared.log 2>&1 &
        sleep 10  # Wait for Cloudflared to establish the tunnel
        echo "VNC URL: $(grep -o 'https://[^ ]*' cloudflared.log)"
        
        cloudflared tunnel info
    - name: Keep the job running
      run: |
        while true; do
          sleep 3600  # Keep the job alive for 1 hour (adjust as needed)
        done
